# Terraform Configuration for Cloudflare Tunnel

This directory contains Terraform configuration to automatically provision a Cloudflare Tunnel for the Claude Code Remote Access system.

## What This Does

- Creates a Cloudflare Tunnel with a secure random secret
- Configures tunnel ingress rules to forward traffic to localhost:8000
- Creates a DNS CNAME record pointing to the tunnel
- Generates local cloudflared credentials and config files

## Prerequisites

1. **Terraform installed** (v1.0 or higher)
   ```bash
   brew install terraform
   ```

2. **Cloudflare account** with:
   - A domain added to Cloudflare
   - API token with permissions:
     - Account.Cloudflare Tunnel (Read/Edit)
     - Zone.DNS (Edit)
     - Zone.Zone (Read)

3. **Get your IDs:**
   - Account ID: https://dash.cloudflare.com/ → Click on your domain → Overview (right sidebar)
   - Zone ID: Same page, scroll down
   - API Token: https://dash.cloudflare.com/profile/api-tokens → Create Token

## Setup

1. **Copy the example variables file:**
   ```bash
   cp terraform.tfvars.example terraform.tfvars
   ```

2. **Edit `terraform.tfvars` with your values:**
   ```hcl
   cloudflare_api_token  = "your-api-token-here"
   cloudflare_account_id = "abc123..."
   cloudflare_zone_id    = "def456..."
   tunnel_hostname       = "remote-agent.yourdomain.com"
   tunnel_subdomain      = "remote-agent"
   ```

3. **Initialize Terraform:**
   ```bash
   terraform init
   ```

4. **Review the plan:**
   ```bash
   terraform plan
   ```

5. **Apply the configuration:**
   ```bash
   terraform apply
   ```

## What Gets Created

After running `terraform apply`:

- ✅ Cloudflare Tunnel named "agent-remote-access"
- ✅ DNS record: `remote-agent.yourdomain.com` → tunnel
- ✅ Local credentials file: `../.cloudflared/<TUNNEL-ID>.json`
- ✅ Local config file: `../.cloudflared/config.yml`

## Running the Tunnel

After Terraform completes, simply run:

```bash
# From the project root
cloudflared tunnel run
```

Or use the command from Terraform output:
```bash
terraform output cloudflared_command
```

## Accessing the Service

Your FastAPI server will be accessible at:
```
https://remote-agent.yourdomain.com
```

## Outputs

Terraform provides helpful outputs:

```bash
# See all outputs
terraform output

# Get specific value
terraform output tunnel_url
```

## Updating Configuration

To change settings:
1. Edit `terraform.tfvars`
2. Run `terraform apply`

## Destroying Resources

To remove all Cloudflare resources:
```bash
terraform destroy
```

**Note:** This will delete the tunnel and DNS record, but won't affect your local files.

## Files Created

```
terraform/
├── cloudflare.tf              # Main configuration
├── variables.tf               # Input variables
├── outputs.tf                 # Output values
├── terraform.tfvars.example   # Example config
├── terraform.tfvars           # Your config (gitignored)
├── templates/
│   └── cloudflared_config.yml.tpl  # Config template
└── README.md                  # This file

../.cloudflared/               # Generated by Terraform
├── <TUNNEL-ID>.json          # Credentials (gitignored)
└── config.yml                # Cloudflared config (gitignored)
```

## Troubleshooting

**"Error creating tunnel: tunnel with that name already exists"**
- Either import existing tunnel: `terraform import cloudflare_tunnel.agent_remote_access <TUNNEL-ID>`
- Or delete existing tunnel in Cloudflare dashboard and retry

**"DNS record already exists"**
- Import existing record or delete it from Cloudflare dashboard

**"Invalid API token"**
- Verify token has correct permissions
- Check token hasn't expired
- Ensure `cloudflare_account_id` and `cloudflare_zone_id` are correct

## Security Notes

- `terraform.tfvars` contains sensitive data - it's gitignored
- Credentials file is automatically created with 0600 permissions
- Never commit `.tfstate` files (also gitignored)
